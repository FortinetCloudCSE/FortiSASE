config sys glo
    set admin-sport ${admin_port}
    set hostname "HUB-FGT"
    set admintimeout 60
end
config system admin
    edit "admin"
        set password ${fgt_password}
    next
end
config router static
    edit 1
        set dst ${cidrhost(hub_subnet_cidr_port1, 0)}/24
        set gateway ${cidrhost(hub_subnet_cidr_port1, 1)}
        set device "port2"
    next
end
config system interface
    edit port1
        set description "untrust"
    next
    edit port2
        set description "trust"
        set allowaccess ping https
    next
    edit "toBranch"
        set vdom "root"
        set ip 169.254.254.1 255.255.255.255
        set allowaccess ping https http
        set type tunnel
        set remote-ip 169.254.254.2 255.255.255.255
        set interface "port1"
    next
end
config vpn ipsec phase1-interface
    edit "toBranch"
        set interface "port1"
        set peertype any
        set net-device disable
        set proposal aes128-sha256 aes256-sha256 aes128-sha1 aes256-sha1
        set comments "VPN: toBranch"
        set wizard-type static-fortigate
        set remote-gw ${branch_fgt_ip}
        set psksecret Fortinet1!
    next
end
config vpn ipsec phase2-interface
    edit "toBranch"
        set phase1name "toBranch"
        set proposal aes128-sha1 aes256-sha1 aes128-sha256 aes256-sha256 aes128gcm aes256gcm chacha20poly1305
        set comments "VPN: toBranch"
        set src-addr-type name
        set dst-addr-type name
        set src-name "all"
        set dst-name "all"
    next
end
config router bgp
    set as 65251
    set router-id 169.254.254.1
    config neighbor
        edit "169.254.254.2"
            set next-hop-self enable
            set soft-reconfiguration enable
            set remote-as 65252
        next
    end
    config network
        edit 1
            set prefix ${cidrhost(hub_subnet_cidr_port1, 0)}/24
        next
    end
end
config firewall vip
    edit "windows-server"
        set mappedip ${hub_webserver_internal_ip}
        set extintf "port1"
        set portforward enable
        set extport 50102
        set mappedport 50102
    next
end
config firewall policy
    edit 1
        set name "ToBR_local"
        set srcintf "port2"
        set dstintf "toBranch"
        set action accept
        set srcaddr "all"
        set dstaddr "all"
        set schedule "always"
        set service "ALL"
        set comments "VPN: ToBR"
    next
    edit 2
        set name "ToBR_remote"
        set srcintf "toBranch"
        set dstintf "port2"
        set action accept
        set srcaddr "all"
        set dstaddr "all"
        set schedule "always"
        set service "ALL"
        set comments "VPN: ToBR"
    next
    edit 3
        set name "Inbound"
        set srcintf "port1"
        set dstintf "port2"
        set action accept
        set srcaddr "all"
        set dstaddr "windows-server"
        set schedule "always"
        set service "ALL"
        set logtraffic all
        set nat enable
    next
end